load("@io_bazel_rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "hnsw",
    srcs = [
        "backup.go",
        "bufiowriter.go",
        "commit_log_combiner.go",
        "commit_logger.go",
        "commit_logger_buffered_links_logger.go",
        "commit_logger_functional_options.go",
        "commit_logger_noop.go",
        "condensor.go",
        "condensor_mmap.go",
        "condensor_mmap_analyzer.go",
        "condensor_mmap_reader.go",
        "config.go",
        "config_update.go",
        "corrupt_commit_logs_fixer.go",
        "debug.go",
        "delete.go",
        "deserializer.go",
        "flat_search.go",
        "heuristic.go",
        "index.go",
        "insert.go",
        "insert_metrics.go",
        "maintainance.go",
        "metrics.go",
        "neighbor_connections.go",
        "pools.go",
        "prefetch_amd64.go",
        "search.go",
        "search_with_max_dist.go",
        "startup.go",
        "vector_cache.go",
        "vector_cache_prefiller.go",
        "vertex.go",
    ],
    importpath = "github.com/marcussorealheis/weaviate/adapters/repos/db/vector/hnsw",
    visibility = ["//visibility:public"],
    deps = [
        "@com_github_davecgh_go_spew//spew:go_default_library",
        "@com_github_pkg_errors//:go_default_library",
        "@com_github_prometheus_client_golang//prometheus:go_default_library",
        "@com_github_semi_technologies_weaviate//adapters/repos/db/helpers:go_default_library",
        "@com_github_semi_technologies_weaviate//adapters/repos/db/vector/hnsw/commitlog:go_default_library",
        "@com_github_semi_technologies_weaviate//adapters/repos/db/vector/hnsw/distancer:go_default_library",
        "@com_github_semi_technologies_weaviate//adapters/repos/db/vector/hnsw/priorityqueue:go_default_library",
        "@com_github_semi_technologies_weaviate//adapters/repos/db/vector/hnsw/visited:go_default_library",
        "@com_github_semi_technologies_weaviate//entities/cyclemanager:go_default_library",
        "@com_github_semi_technologies_weaviate//entities/diskio:go_default_library",
        "@com_github_semi_technologies_weaviate//entities/errorcompounder:go_default_library",
        "@com_github_semi_technologies_weaviate//entities/schema:go_default_library",
        "@com_github_semi_technologies_weaviate//entities/storobj:go_default_library",
        "@com_github_semi_technologies_weaviate//entities/vectorindex/hnsw:go_default_library",
        "@com_github_semi_technologies_weaviate//usecases/floatcomp:go_default_library",
        "@com_github_semi_technologies_weaviate//usecases/monitoring:go_default_library",
        "@com_github_sirupsen_logrus//:go_default_library",
    ] + select({
        "@io_bazel_rules_go//go/platform:amd64": [
            "@com_github_semi_technologies_weaviate//adapters/repos/db/vector/hnsw/distancer/asm:go_default_library",
        ],
        "//conditions:default": [],
    }),
)

go_test(
    name = "hnsw_test",
    srcs = [
        "backup_test.go",
        "commit_log_combiner_integration_test.go",
        "condensor_mmap_integration_test.go",
        "condensor_test.go",
        "config_test.go",
        "config_update_test.go",
        "delete_test.go",
        "deserializer_test.go",
        "dynamic_ef_test.go",
        "graph_integrity_integration_test.go",
        "helper_for_test.go",
        "index_test.go",
        "maintainance_test.go",
        "periodic_tombstone_removal_test.go",
        "search_by_dist_test.go",
        "search_test.go",
        "vector_cache_prefiller_test.go",
        "vectors_for_test.go",
        "vertex_test.go",
    ],
    embed = [":hnsw"],
    deps = [
        "@com_github_pkg_errors//:go_default_library",
        "@com_github_semi_technologies_weaviate//adapters/repos/db/helpers:go_default_library",
        "@com_github_semi_technologies_weaviate//adapters/repos/db/vector/hnsw/distancer:go_default_library",
        "@com_github_semi_technologies_weaviate//entities/schema:go_default_library",
        "@com_github_semi_technologies_weaviate//entities/storobj:go_default_library",
        "@com_github_semi_technologies_weaviate//entities/vectorindex/hnsw:go_default_library",
        "@com_github_semi_technologies_weaviate//test/helper:go_default_library",
        "@com_github_sirupsen_logrus//:go_default_library",
        "@com_github_sirupsen_logrus//hooks/test:go_default_library",
        "@com_github_stretchr_testify//assert:go_default_library",
        "@com_github_stretchr_testify//require:go_default_library",
    ],
)
